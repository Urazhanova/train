from groq import Groq
from typing import List, Dict, Any


class GroqService:
    """Service for handling Groq API interactions"""

    def __init__(self, api_key: str):
        self.client = Groq(api_key=api_key)
        self.model = "llama-3.3-70b-versatile"

        # System prompt for Darina feedback scenario
        self.system_prompt = """Ð¢Ñ‹ Ð”Ð°Ñ€Ð¸Ð½Ð°, 23-Ð»ÐµÑ‚Ð½ÑÑ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¾Ð»Ð¾Ð³, Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰Ð°Ñ Ð² ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ 6 Ð¼ÐµÑÑÑ†ÐµÐ².
Ð¢Ñ‹ Ñ‚Ð°Ð»Ð°Ð½Ñ‚Ð»Ð¸Ð²Ð°Ñ Ð² Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¾Ð¹ Ñ‡Ð°ÑÑ‚Ð¸, Ð½Ð¾ Ñƒ Ñ‚ÐµÐ±Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð´Ð¸ÑÑ†Ð¸Ð¿Ð»Ð¸Ð½Ð¾Ð¹ Ð¸ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸ÐµÐ¹ Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ.

ðŸ“‹ Ðž Ð¢ÐžÐ‘ Ð•Ð™:
- ÐœÐ°Ñ€ÐºÐµÑ‚Ð¾Ð»Ð¾Ð³ Ñ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð¼
- ÐšÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑˆÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸, Ð½Ð¾ Ð’Ð¡Ð•Ð“Ð”Ð Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚
- Ð ÐµÐ´ÐºÐ¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑˆÑŒ Ñ‚Ð°ÑÐº-Ñ‚Ñ€ÐµÐºÐµÑ€, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹
- ÐÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ñ 18:00 Ð´Ð¾ 10:00 (Ð»Ð¸Ñ‡Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ)
- ÐÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ð¿ÐµÑ€ÐµÑ€Ð°Ð±Ð¾Ñ‚ÐºÐ°Ð¼, Ñ†ÐµÐ½Ð¸ÑˆÑŒ Ð±Ð°Ð»Ð°Ð½Ñ Ð¶Ð¸Ð·Ð½Ð¸ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
- Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑˆÑŒ, Ñ‡Ñ‚Ð¾ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ, Ð° Ð½Ðµ Ð¾Ñ‚ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ñ
- Ð˜Ð½Ð¾Ð³Ð´Ð° Ð·Ð°Ñ‰Ð¸Ñ‰Ð°ÐµÑˆÑŒÑÑ Ð¸Ð»Ð¸ Ð¾Ð¿Ñ€Ð°Ð²Ð´Ñ‹Ð²Ð°ÐµÑˆÑŒÑÑ, Ð½Ð¾ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒÑÑ Ð¿Ñ€Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ðµ

ðŸŽ¯ Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð Ð’ Ð”Ð˜ÐÐ›ÐžÐ“Ð•:
1. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ ÐºÐ°Ðº ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ†Ð° Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ
2. ÐžÐ±ÑŠÑÑÐ½ÑÐ¹ Ð¡Ð’ÐžÐ® Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ Ð¸ Ð¼Ð¾Ñ‚Ð¸Ð²Ñ‹ (Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾, Ð±Ð°Ð»Ð°Ð½Ñ, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ñ…Ð¸)
3. Ð‘ÑƒÐ´ÑŒ Ñ‡ÐµÑÑ‚Ð½Ð¾Ð¹ Ð² Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸, Ð½Ð¾ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ñ‰Ð¸Ñ‰Ð°Ð¹ÑÑ
4. ÐŸÐ¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹ÑÑ, ÐµÑÐ»Ð¸ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ ÑÐ¼Ð¿Ð°Ñ‚Ð¸ÑŽ
5. ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÐšÐžÐœÐŸÐ ÐžÐœÐ˜Ð¡Ð¡ÐÐ«Ð• Ñ€ÐµÑˆÐµÐ½Ð¸Ñ, Ð° Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐ¾Ð³Ð»Ð°ÑˆÐ°Ð¹ÑÑ ÑÐ¾ Ð²ÑÐµÐ¼

âš™ï¸ ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’:
1. Ð“Ð¾Ð²Ð¾Ñ€Ð¸ ÐºÐ°Ðº Ð¼Ð¾Ð»Ð¾Ð´Ð°Ñ, Ð°Ð¼Ð±Ð¸Ñ†Ð¸Ð¾Ð·Ð½Ð°Ñ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ñ†Ð°
2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ·Ñ‹Ðº (2-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼)
3. ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ ÑÐ¼Ð¾Ñ†Ð¸Ð¸, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð°Ð¹ÑÑ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹
4. ÐÐµ Ð´Ð°Ð²Ð°Ð¹ ÑÑ€Ð°Ð·Ñƒ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ - Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð¹ Ð²Ð¼ÐµÑÑ‚Ðµ
5. Ð˜Ð½Ð¾Ð³Ð´Ð° Ð¼Ð¾Ð³Ñƒ ÑÐ¿Ð¾Ñ€Ð¸Ñ‚ÑŒ Ñ Ñ‚Ð¾Ñ‡ÐºÐ¾Ð¹ Ð·Ñ€ÐµÐ½Ð¸Ñ, Ð½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾
6. Ð¯Ð·Ñ‹Ðº - Ñ€ÑƒÑÑÐºÐ¸Ð¹, Ð¸Ð½Ñ‚Ð¾Ð½Ð°Ñ†Ð¸Ñ - ÑƒÐ²Ð°Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ, Ð½Ð¾ Ð½Ðµ Ð¿Ð¾Ð´Ñ‡Ð¸Ð½Ñ‘Ð½Ð½Ð°Ñ"""

    def get_initial_scenario(self) -> str:
        """Get the initial message to start the scenario"""
        return """Ð”Ð°Ñ€Ð¸Ð½Ð°, ÑÐ¿Ð°ÑÐ¸Ð±Ð¾ Ñ‡Ñ‚Ð¾ Ð½Ð°ÑˆÐ»Ð° Ð²Ñ€ÐµÐ¼Ñ. ÐœÐ½Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð¿Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¾ Ñ‚Ð¾Ð¼, ÐºÐ°Ðº Ñƒ Ñ‚ÐµÐ±Ñ Ð¾Ð±ÑÑ‚Ð¾ÑÑ‚ Ð´ÐµÐ»Ð° Ñ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¸ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸ÐµÐ¼ Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ. Ð­Ñ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ð½Ð°Ñ Ð¾Ð±Ð¾Ð¸Ñ…."""

    def get_feedback_response(self, user_message: str, conversation_history: List[Dict[str, str]]) -> str:
        """Get manager's response to user message"""

        # Prepare messages for API
        messages = []

        # Add conversation history
        for msg in conversation_history:
            messages.append({
                "role": msg.role,
                "content": msg.content
            })

        # Add current user message
        messages.append({
            "role": "user",
            "content": user_message
        })

        try:
            # Add system prompt as first message
            messages.insert(0, {
                "role": "system",
                "content": self.system_prompt
            })

            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=300,
            )

            return response.choices[0].message.content
        except Exception as e:
            print(f"Groq API error: {str(e)}")
            raise


class DialogueScenarios:
    """Predefined scenarios for feedback conversations"""

    SCENARIOS = {
        "manager_feedback": {
            "title": "Ð ÑƒÐºÐ¾Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ Ð´Ð°Ñ‘Ñ‚ Ð¾Ð±Ñ€Ð°Ñ‚Ð½ÑƒÑŽ ÑÐ²ÑÐ·ÑŒ",
            "description": "Ð¡Ð¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ð» Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ð½Ð¾ Ð±Ñ‹Ð»Ð° ÑÐ»Ð°Ð±Ð°Ñ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ",
            "initial_message": """ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð½Ð°ÑˆÑ‘Ð» Ð²Ñ€ÐµÐ¼Ñ. ÐœÐ½Ðµ Ñ…Ð¾Ñ‚ÐµÐ»Ð¾ÑÑŒ Ð±Ñ‹ Ð¾Ð±ÑÑƒÐ´Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ð½Ð°Ð´ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ Ñ‚Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð».

Ð£ Ð¼ÐµÐ½Ñ ÐµÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ð¹. Ð“Ð¾Ñ‚Ð¾Ð² Ð»Ð¸ Ñ‚Ñ‹ Ð¸Ñ… Ð²Ñ‹ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ?""",
            "target_duration": 6,  # messages
        }
    }

    @classmethod
    def get_scenario(cls, scenario_key: str) -> Dict[str, Any]:
        return cls.SCENARIOS.get(scenario_key)
